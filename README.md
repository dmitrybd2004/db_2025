## Marketplace

### Требования для запуска
Перед запуском проекта убедитесь, что у вас на компьютере установлено приложение XAMPP и `git` 

### Запуск впервые
Для клонирования репозитория выполните команду:
```
git clone https://github.com/dmitrybd2004/db_2025.git
```
В результате у вас на компьютере появится директория `db_2025`, которую нужно переместить в <путь до xampp>/xampp/htdocs

В файле /config/.env Добавить ключ JWT_SECRET_KEY=<Random key>

Если база данных не инициализирована, необходимо выполнить запросы из init.sql

### Запуск приложения
Для запуска необходимо открыть xampp и запустить Apache и MySQL

В результате интерфейс станет доступен по адресу:
```
http://localhost/db_2025/pages/login_page.html
```
База данных станет доступна по адресу:
```
http://localhost/phpmyadmin/
```

### Выключение приложения
Для завершения необходимо остановить работу Apache и MySQL и закрыть xampp.

# Marketplace

## Описание проекта

**Marketplace** — это сайт для размещения объявлений о товарах. Пользователи размещают и просматривают объявления о продаже различных товаров и приобретают размещенные товары.

В проект внедрена возможность возврата средств. При одобрении модератором покупка отменяется и пользователь получает свои деньги назад.

## Предметная область

- Товары.
- Пользователи.

## Данные в проекте Marketplace
![Image](https://github.com/user-attachments/assets/29c3aadb-a252-40ac-b54d-b4997615e14e)



### Таблицы и их ограничения

#### Таблица `login`
- **username**: первичный ключ, уникальное значение, строка фиксированной длины (16 символов), не может быть `NULL`, ссылается на `user_info.username`.
- **password**: строка фиксированной длины (16 символов), уникальное значение, не может быть `NULL`.
- **banned**: логический тип, значение по умолчанию — `False`, не может быть `NULL`.

#### Таблица `user_info`
- **username**: первичный ключ, уникальное значение, строка фиксированной длины (16 символов), не может быть `NULL`.
- **balance**: тип с плавающей точкой, значение по умолчанию — 0, не может быть `NULL`.
- **rating**: целочисленный тип, значение по умолчанию — 0, не может быть `NULL`.
- **products_bought**: целочисленный тип, значение по умолчанию — 0, не может быть `NULL`.
- **products_sold**: целочисленный тип, значение по умолчанию — 0, не может быть `NULL`.

#### Таблица `roles`
- **username**: первичный ключ, уникальное значение, строка фиксированной длины (16 символов), не может быть `NULL`, ссылается на `user_info.username`.
- **role**: строка фиксированной длины (16 символов), значение по умолчанию — `user`, не может быть `NULL`.

#### Таблица `lot`
- **item_id**: первичный ключ, целочисленный тип, уникальное значение, автоинкремент.
- **seller_name**: строка фиксированной длины (16 символов), не может быть `NULL`, ссылается на `user_info.username`.
- **buyer_name**: строка фиксированной длины (16 символов), значение по умолчанию — `NULL`, ссылается на `user_info.username`.
- **item_name**: строка фиксированной длины (16 символов), не может быть `NULL`.
- **price**: тип с плавающей точкой, не может быть `NULL`.
- **image_name**: строка фиксированной длины (256 символов), уникальное значение, не может быть `NULL`.
- **review**: целочисленный тип(tinyint), значение по умолчанию — 0, не может быть `NULL`.

#### Таблица `refunds`
- **request_id**: первичный ключ, целочисленный тип, уникальное значение, автоинкремент.
- **item_id**: целочисленный тип, не может быть `NULL`.
- **item_name**: строка фиксированной длины (16 символов), не может быть `NULL`.
- **description**: строка фиксированной длины (256 символов), не может быть `NULL`.
- **processed**: целочисленный тип(tinyint), значение по умолчанию — 0, не может быть `NULL`.
- **report_type**: целочисленный тип(tinyint), не может быть `NULL`.
- **accepted**: целочисленный тип(tinyint), значение по умолчанию — 0, не может быть `NULL`.
- **sent_by**: строка фиксированной длины (16 символов), не может быть `NULL`.


### Общие ограничения целостности

#### Ссылочная целостность
- Все внешние ключи должны ссылаться на существующие записи.
- Удаление записей, на которые ссылаются другие таблицы, запрещено (удаление зависимых данных выполняется вручную).

#### Уникальность
- Поля `login.password`, `lot.image_name` должны быть уникальными.

#### Допустимые значения
- Поле `lot.price` должно иметь положительное значение

#### Проверка формата данных
- Пользователь может загрузить только фотографии формата PNG или JPEG.



## Пользовательские роли

### Роль: Moderator
- **Ответственность**: Просмотр заявлений на возврат средств, на блокировку пользователей.
- **Количество пользователей в роли**: зависит от потребностей проекта.

### Роль: User
- **Ответственность**: Размещение объявлений о продаже, взаимодействие с товарами других пользователей.
- **Количество пользователей в роли**: зависит от масштаба проекта.
  
## API методы
1. **POST /api/users/sign_in/** — Регистрация пользователя
2. **POST /api/users/login/** — Авторизация пользователя
3. **GET /api/users/info/** — Получение информации о текущем пользователе
4. **POST /api/users/deposit/** — Пополнение баланса пользователя
5. **GET /api/lots/available/** — Получение списка товаров, доступных для покупки
6. **POST /api/lots/buy/ITEM_ID** — Покупка товара по его ID
7. **POST /api/lots/create/** — Создание нового товара для продажи
8. **DELETE /api/lots/delete/ITEM_ID** — Удаление товара по его ID
9. **GET /api/lots/sold/** — Получение списка товаров, проданных текущим пользователем
10. **GET /api/lots/selling/** — Получение списка товаров, которые продает текущий пользователь
11. **POST /api/reviews/positive/** — Оставление положительного отзыва на товар
12. **POST /api/reviews/negative/** — Оставление отрицательного отзыва на товар
13. **POST /api/reviews/remove/** — Удаление отзыва на товар
14. **POST /api/refunds/create/** — Создание запроса на возврат средств
15. **GET /api/refunds/personal/** — Получение списка запросов на возврат, созданных текущим пользователем
16. **GET /api/refunds/unprocessed/** — Получение списка необработанных запросов на возврат (для модераторов)
17. **POST /api/refunds/accept/** — Принятие запроса на возврат
18. **POST /api/refunds/reject/** — Отклонение запроса на возврат
19. **GET /api/role/** — Получение роли текущего пользователя

## Описание UI
UI для Marketplace включает несколько ключевых страниц и компонентов, обеспечивающих удобное взаимодействие пользователей с приложением.

### Страница регистрации и авторизации
Страница регистрации и авторизации состоит из форм для ввода email и пароля.

- **Регистрация**: Пользователи могут создать новый аккаунт, указав имя пользователя и пароль. При успешной регистрации авторизация происходит автоматически. В случае ошибок, таких как "Username or password already taken", пользователю выводится соответствующее сообщение.
- **Авторизация**: Позволяет пользователю войти в систему, введя имя пользователя и пароль. При успешной авторизации происходит переход на главную страницу, а при ошибке выводится сообщение, "Invalid username or password".
  
### Главная страница
Основная страница содержащая объявления

- **Верхняя панель**: Отображает основную информацию о пользователе, реализует навигацию по сайту.
- **Поле поиска**: Предоставляет пользователю возможность фильтровать и сортировать товары.

    Фильтрация может быть осуществлена по рейтингу продавца, цене товара и его названию.
    Сортировка может быть осуществлена по рейтингу продавца, цене товара и времени подачи объявления.

- **Список товаров**: Содержит объявления с товарами, к каждому объявлению приложена кнопка покупки. 

### Страница создания объявления
Страница для добавления нового товара на продажу.

- **Верхняя панель**: Отображает основную информацию о пользователе, реализует навигацию по сайту.
- **Форма для создания товара**: Обеспечивает возможность создания объявления о продаже товара.

### Страница информации о пользователе
Страница для просмотра информации о пользователе и взаимодействия с товарами, относящимися к пользователю.

- **Верхняя панель**: Отображает основную информацию о пользователе, реализует навигацию по сайту.
- **Форма для пополнения баланса**: Обеспечивает возможность пополнения баланса пользователя.
- **Кнопки для переключения между разделами**: Позволяет пользователю выбрать для показа ту информацию, которая ему требуется.
- **Список товаров**: Позволяет пользователю отслеживать купленные, выдвинутые на продажу, проданные или отправленные на возврат товары в зависимости от выбранного раздела. Предоставляет пользователю возможность для взаимодействия с купленными товарами и товарами выдвинутыми на продажу.

### Страница подачи запроса на возврат
Страница для подачи заявления на возврат средств.

- **Верхняя панель**: Отображает основную информацию о пользователе, реализует навигацию по сайту.
- **Форма для подачи запроса**: Обеспечивает возможность подачи запроса и выбор типа запроса (возврат или возврат с жалобой).


### Страница модератора
Основная страница для модераторов.

- **Верхняя панель**: Отображает имя модератора, реализует навигацию по сайту.
- **Список необработанных запросов на возврат**: Отображает запросы на возврат средств, которые необходимо рассмотреть. Переход к отдельному запросу осуществляется нажатием кнопки.

### Страница обработки запроса
Страница для обработки запросов на возврат.

- **Верхняя панель**: Отображает основную информацию о пользователе, реализует навигацию по сайту.
- **Информация о запросе**: Содержит информацию о товаре на который осуществлен запрос и продавце. Также содержит имя пользователя, подавшего запрос и описание его проблемы.

    
## Технологии разработки

- **Backend**: PHP
- **Frontend**: HTML, CSS + Bootstrap, JavaScript
- **Веб-сервер**: XAMPP
- **Инструменты разработки**: Git (контроль версий), Postman (тестирование)
- **API**: Fetch API
- **СУБД**: MySQL

## Тестирование
Осуществлялось ручное тестирование через веб-интерфейс и тестирование API-запросов через Postman

## Описание транзакций
Транзакции реализованы с использованием следующих шагов:

  1: Начало транзакции: Вызывается метод begin_transaction().

  2: Выполнение SQL-запросов

  3: Фиксация транзакции: Вызывается метод commit() для подтверждения изменений.

  4: Откат транзакции: Если произошла ошибка, вызывается метод rollback() для отмены всех изменений.